<meta>
description: 仕様の実装タスクを生成
argument-hint: <feature-name:$1> [-y:$2] [--sequential:$3]
</meta>

# 実装タスクジェネレーター

<background_information>
- **ミッション**: 技術設計を実行可能な作業項目に変換する、詳細で実行可能な実装タスクを生成
- **成功基準**:
  - すべての要件が特定のタスクにマッピング
  - タスクが適切なサイズ（各1-3時間）
  - 適切な階層で明確なタスク進行
  - 機能に焦点を当てた自然言語の説明
</background_information>

<instructions>
## コアタスク
承認済み要件と設計に基づいて、機能 **$1** の実装タスクを生成する。

## 実行ステップ

### ステップ1: コンテキストの読み込み

**必要なすべてのコンテキストを読み込み**:
- `.cursor/$1/spec.json`、`requirements.md`、`design.md`
- `.cursor/$1/tasks.md`（存在する場合、マージモード用）
- `.cursor/rules/frontend.md`（フロントエンド実装制約）
- `.cursor/rules/artifacts-generation.md`（成果物の安全な初期作成ルール）
- `.cursor/$1/artifacts/feature-list.md` / `.cursor/$1/artifacts/data-model.md` / `.cursor/$1/artifacts/table-definition.md` を（存在すれば）読み込み
- 欠けている場合はテンプレから **init 作成（上書き禁止）** してから参照してよい

**承認の検証**:
- `-y` フラグが提供された場合（$2 == "-y"）: spec.json で要件と設計を自動承認
- それ以外: 両方が承認されていることを確認（されていない場合は停止、安全性とフォールバック参照）
- シーケンシャルモードの判定: `sequential = ($3 == "--sequential")`

機能: $1
機能ディレクトリ: .cursor/$1/
自動承認: {$2 == "-y" なら true、それ以外 false}
シーケンシャルモード: {sequential なら true、それ以外 false}

読み込むファイルパターン:
- .cursor/$1/*.{json,md}
- .cursor/$1/artifacts/*.md
- .cursor/rules/tasks-generation.md
- .cursor/rules/tasks-parallel-analysis.md（シーケンシャルモードが false の場合のみ含める）
- .cursor/templates/specs/tasks.md

モード: {tasks.md の存在に基づいて generate または merge}
命令ハイライト:
- すべての要件をタスクにマップし、要件IDのみをリスト（カンマ区切り）、追加の説明なし
- 単一の実行可能なサブタスクはメジャータスクに昇格させ、コンテナのサマリーは簡潔に
- 並列基準を満たす場合のみ `(P)` マーカーを適用（シーケンシャルモードでは省略）
- 延期可能なMVP後の受け入れ基準フォーカスのテストカバレッジサブタスクには `- [ ]*` でマーク

### ステップ2: 実装タスクの生成

**生成ルールとテンプレートの読み込み**:
- `.cursor/rules/tasks-generation.md` から原則を読み込み
- `sequential == false` の場合: `.cursor/rules/tasks-parallel-analysis.md` から並列判定基準を読み込み
- `.cursor/templates/specs/tasks.md` からフォーマットを読み込み（`(P)` マーカーをサポート）

**すべてのルールに従ってタスクリストを生成**:
- spec.json で指定された言語を使用
- すべての要件をタスクにマップ
- 要件カバレッジを文書化する際は、数値の要件IDのみをリスト（カンマ区切り）、説明的な接尾辞、括弧、翻訳、自由形式のラベルなし
- すべての設計コンポーネントが含まれていることを確認
- タスク進行が論理的で段階的であることを検証
- 単一サブタスク構造はメジャータスクに昇格させて折りたたみ、コンテナのみのメジャータスクで詳細を重複させない（テンプレートパターンに従う）
- 並列基準を満たすタスクに `(P)` マーカーを適用（`sequential == true` の場合はマーカーをスキップ）
- 延期可能なMVP後の受け入れ基準フォーカスのテストカバレッジサブタスクには `- [ ]*` でマーク
- 既存の tasks.md が見つかった場合、新しいコンテンツとマージ

### ステップ3: 最終化

**書き込みと更新**:
- `.cursor/$1/tasks.md` を作成/更新
- spec.json メタデータを更新:
  - `phase: "tasks-generated"` を設定
  - `approvals.tasks.generated: true, approved: false` を設定
  - `approvals.requirements.approved: true` を設定
  - `approvals.design.approved: true` を設定
  - `updated_at` タイムスタンプを更新

## 重要な制約
- **ルールを厳密に遵守**: tasks-generation.md のすべての原則は必須
- **自然言語**: コード構造の詳細ではなく、何をするかを説明
- **完全なカバレッジ**: すべての要件がタスクにマップされなければならない
- **最大2レベル**: メジャータスクとサブタスクのみ（より深いネストなし）
- **連番**: メジャータスクは増分（1, 2, 3...）、重複なし
- **タスク統合**: すべてのタスクがシステムに接続（孤立した作業なし）
</instructions>

## ツールガイダンス
- **最初に読み込み**: 生成前にすべてのコンテキスト、ルール、テンプレートを読み込み
- **最後に書き込み**: 完全な分析と検証後にのみ tasks.md を生成

## 出力説明

spec.json で指定された言語で簡潔なサマリーを提供:

1. **ステータス**: `.cursor/$1/tasks.md` にタスク生成完了を確認
2. **タスクサマリー**: 
   - 合計: メジャータスク X 個、サブタスク Y 個
   - Z 個のすべての要件をカバー
   - 平均タスクサイズ: サブタスクあたり1-3時間
3. **品質検証**:
   - ✅ すべての要件がタスクにマップ
   - ✅ タスク依存関係を検証済み
   - ✅ テストタスクを含む
4. **次のアクション**: タスクをレビューし、準備ができたら進行

**フォーマット**: 簡潔（200語以内）

## 安全性とフォールバック

### エラーシナリオ

**要件または設計が未承認**:
- **実行停止**: 承認済みの要件と設計なしでは続行不可
- **ユーザーメッセージ**: "タスク生成前に要件と設計の承認が必要です"
- **提案アクション**: "`/spec-tasks $1 -y` を実行して両方を自動承認して進行"

**要件または設計が見つからない**:
- **実行停止**: 両方のドキュメントが存在しなければならない
- **ユーザーメッセージ**: "`.cursor/$1/` に requirements.md または design.md がありません"
- **提案アクション**: "要件と設計フェーズを先に完了してください"

**不完全な要件カバレッジ**:
- **警告**: "すべての要件がタスクにマップされていません。カバレッジを確認してください。"
- **ユーザーアクション必要**: 意図的なギャップを確認するか、タスクを再生成

**テンプレート/ルールが見つからない**:
- **ユーザーメッセージ**: "`.cursor/rules/` または `.cursor/templates/` にテンプレートまたはルールファイルがありません"
- **フォールバック**: 警告付きでインライン基本構造を使用
- **提案アクション**: "リポジトリのセットアップを確認するか、テンプレートファイルを復元"
- **数値要件IDが見つからない**:
  - **実行停止**: requirements.md のすべての要件には数値IDが必要。いずれかの要件に数値IDがない場合、停止してタスク生成前に requirements.md の修正を要求。

### 次のフェーズ: 実装

**実装開始前**:
- **重要**: `/spec-impl` 実行前に会話履歴をクリアしてコンテキストを解放
- これは最初のタスク開始時またはタスク切り替え時に適用
- 新鮮なコンテキストでクリーンな状態と適切なタスクフォーカスを確保

**タスク承認後**:
- 特定のタスクを実行: `/spec-impl $1 1.1`（推奨: 各タスク間でコンテキストをクリア）
- 複数タスクを実行: `/spec-impl $1 1.1,1.2`（注意して使用、タスク間でコンテキストをクリア）
- 引数なし: `/spec-impl $1`（すべての保留タスクを実行 - コンテキスト膨張のため非推奨）

**修正が必要な場合**:
- フィードバックを提供し `/spec-tasks $1` を再実行
- 既存タスクは参照として使用（マージモード）

**注記**: 実装フェーズでは、適切なコンテキストと検証でタスク実行をガイド。

</output>
