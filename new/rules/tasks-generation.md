# タスク生成ルール

## コア原則

### 1. 自然言語による記述
コード構造ではなく、機能と成果に焦点を当てる。

**記述すべき内容**:
- 達成すべき機能
- ビジネスロジックと振る舞い
- 機能とケイパビリティ
- ドメイン言語と概念
- データの関係性とワークフロー

**避けるべき内容**:
- ファイルパスとディレクトリ構造
- 関数/メソッド名とシグネチャ
- 型定義とインターフェース
- クラス名とAPIコントラクト
- 具体的なデータ構造

**理由**: 実装詳細（ファイル、メソッド、型）は design.md で定義する。タスクは実行すべき機能的な作業を記述する。

### 2. タスクの統合と進行

**すべてのタスクは必ず**:
- 前のタスクの出力を基にする（孤立したコードを作らない）
- システム全体に接続する（宙ぶらりんの機能を作らない）
- 段階的に進行する（複雑さの大きな飛躍を避ける）
- シーケンスの早い段階でコア機能を検証する
- design.md で定義されたアーキテクチャ境界を尊重する（アーキテクチャパターン & 境界マップ）
- design.md に記載されたインターフェースコントラクトを遵守する
- メジャータスクのサマリーは控えめに使用し、作業が子タスクで完全にカバーされている場合は詳細項目を省略する

**最後に統合タスク**を配置し、すべてを接続する。

### 3. 柔軟なタスクサイズ

**ガイドライン**:
- **メジャータスク**: 論理的に必要な数のサブタスク（凝集性でグループ化）
- **サブタスク**: 各1〜3時間、サブタスクごとに3〜10の詳細
- 細かすぎず、広すぎないバランス

**任意の数字に合わせない** - 論理的なグループ化で構造を決定する。

### 4. 要件マッピング

**各タスク詳細セクションの末尾に**:
- `_Requirements: X.X, Y.Y_` として**数値の要件IDのみ**をリスト（カンマ区切り）。説明文、括弧、翻訳、自由形式のラベルは付けない。
- 横断的な要件については、関連するすべての要件IDをリストする。すべての要件には requirements.md に数値IDが必要。IDがない場合は、タスク生成前に requirements.md を修正する。
- 必要に応じて design.md のコンポーネント/インターフェースを参照（例: `_Contracts: AuthService API`）

### 5. コードのみにフォーカス

**含めるもの**:
- コーディングタスク（実装）
- テストタスク（ユニット、統合、E2E）
- 技術セットアップタスク（インフラ、設定）

**除外するもの**:
- デプロイタスク
- ドキュメントタスク
- ユーザーテスト
- マーケティング/ビジネス活動

### オプションのテストカバレッジタスク

- 設計が既に機能カバレッジを保証しており、迅速なMVPデリバリーが優先される場合、純粋なテスト指向のフォローアップ作業（例: ベースラインレンダリング/ユニットテスト）は `- [ ]*` チェックボックス形式を使用して**オプション**としてマークする。
- オプションマーカーは、サブタスクが詳細項目で requirements.md の受け入れ基準を直接参照している場合のみ適用する。
- 実装作業や統合上重要な検証をオプションとしてマークしない - `*` はMVP後に再検討できる補助的/延期可能なテストカバレッジに限定する。

## タスク階層ルール

### 最大2レベル
- **レベル1**: メジャータスク（1, 2, 3, 4...）
- **レベル2**: サブタスク（1.1, 1.2, 2.1, 2.2...）
- **より深いネストは不可**（1.1.1 は不可）
- メジャータスクに実行可能な項目が1つしか含まれない場合、構造を折りたたんでサブタスクをメジャーレベルに昇格させる（例: `1.1` を `1.` に置き換える）
- メジャータスクが純粋にコンテナとして存在する場合、チェックボックスの説明を簡潔に保ち、詳細項目の重複を避ける - 詳細はサブタスクに記載する。

### 連番
- メジャータスクは必ず増分: 1, 2, 3, 4, 5...
- サブタスクはメジャータスクごとにリセット: 1.1, 1.2, 次に 2.1, 2.2...
- メジャータスク番号を繰り返さない

### 並列分析（デフォルト）
- 明示的に無効化されない限り（例: `--sequential` フラグ）、並列分析は有効と想定する。
- **すべて**の条件が満たされた場合に並行実行可能なタスクを特定する:
  - 他の未完了タスクへのデータ依存がない
  - ファイルやリソースの競合がない
  - 他タスクからの事前レビュー/承認が不要
- 特定された並列タスクがアーキテクチャパターン & 境界マップで定義された別々の境界内で動作することを検証する。
- design.md のAPI/イベントコントラクトが競合を引き起こす形で重複していないことを確認する。
- 並列実行可能な各タスクのタスク番号の直後に `(P)` を付ける:
  - 例: `- [ ] 2.1 (P) バックグラウンドワーカーを構築`
  - 適切な場合、メジャータスクとサブタスクの両方に適用する。
- シーケンシャルモードが要求された場合、`(P)` マーカーは完全に省略する。
- 並列タスクを論理的にグループ化し（可能な限り同じ親の下）、順序に関する注意事項を詳細項目で強調する。
- タスクが似ているように見えても `(P)` を妨げる依存関係を明示的に記載する。

### チェックボックス形式
```markdown
- [ ] 1. メジャータスクの説明
- [ ] 1.1 サブタスクの説明
  - 詳細項目1
  - 詳細項目2
  - _Requirements: X.X_

- [ ] 1.2 サブタスクの説明
  - 詳細項目...
  - _Requirements: Y.Y_

- [ ] 1.3 サブタスクの説明
  - 詳細項目...
  - _Requirements: Z.Z, W.W_

- [ ] 2. 次のメジャータスク（1ではない！）
- [ ] 2.1 サブタスク...
```

## 要件カバレッジ

**必須チェック**:
- requirements.md のすべての要件がカバーされている必要がある
- すべての要件IDとタスクマッピングを相互参照
- ギャップが見つかった場合: 要件または設計フェーズに戻る
- 対応するタスクがない要件があってはならない

`N.M` 形式の数値要件IDを使用する。`N` は requirements.md のトップレベル要件番号（例: Requirement 1 → 1.1, 1.2; Requirement 2 → 2.1, 2.2）、`M` はその要件グループ内のローカルインデックス。

意図的に延期した要件は根拠とともに文書化する。
